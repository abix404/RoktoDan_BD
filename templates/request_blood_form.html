<!-- request_blood_form.html -->
{% load static %}

<form method="POST" action="{% url 'request_blood_from_donor' donor.id %}"
      id="bloodRequestForm" class="blood-request-form">
    {% csrf_token %}

    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Requesting blood from: {{ donor.full_name }}</strong><br>
        Blood Group: <strong>{{ donor.blood_group }}</strong> | Location: {{ donor.thana }}, {{ donor.district }}
    </div>

    <!-- Patient Information -->
    <h6 class="mb-3 text-primary"><i class="bi bi-person me-2"></i>Patient Information</h6>
    <div class="row mb-3">
        <div class="col-md-6">
            <label class="form-label">Patient Name *</label>
            <input type="text" class="form-control" name="patient_name"
                   value="{{ recipient.full_name }}" required>
        </div>
        <div class="col-md-6">
            <label class="form-label">Patient Age *</label>
            <input type="number" class="form-control" name="patient_age"
                   min="0" max="120" value="{{ recipient.age|default:'25' }}" required>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">Medical Condition/Reason *</label>
        <textarea class="form-control" name="medical_condition" rows="2" required></textarea>
    </div>

    <!-- Hospital Information -->
    <h6 class="mb-3 text-primary"><i class="bi bi-hospital me-2"></i>Hospital Information</h6>
    <div class="mb-3">
        <label class="form-label">Hospital Name *</label>
        <input type="text" class="form-control" name="hospital_name" required>
    </div>
    <div class="mb-3">
        <label class="form-label">Hospital Address *</label>
        <textarea class="form-control" name="hospital_address" rows="2" required></textarea>
    </div>

    <!-- Blood Requirement -->
    <h6 class="mb-3 text-primary"><i class="bi bi-droplet me-2"></i>Blood Requirement</h6>
    <div class="row mb-3">
        <div class="col-md-6">
            <label class="form-label">Units/Bags Needed *</label>
            <input type="number" class="form-control" name="units_needed" min="1" max="10" value="1" required>
        </div>
        <div class="col-md-6">
            <label class="form-label">Urgency Level *</label>
            <select class="form-select" name="urgency_level" required>
                <option value="low">Low - Within a week</option>
                <option value="medium" selected>Medium - Within 2-3 days</option>
                <option value="high">High - Within 24 hours</option>
                <option value="critical">Critical - Emergency (ASAP)</option>
            </select>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Blood Needed By *</label>
        <input type="datetime-local" class="form-control" id="needed_by_date" name="needed_by_date" required>
    </div>

    <!-- Contact Information -->
    <h6 class="mb-3 text-primary"><i class="bi bi-telephone me-2"></i>Contact Information</h6>
    <div class="row mb-3">
        <div class="col-md-6">
            <label class="form-label">Contact Person *</label>
            <input type="text" class="form-control" name="contact_person" value="{{ recipient.full_name }}" required>
        </div>
        <div class="col-md-6">
            <label class="form-label">Contact Number *</label>
            <input type="tel" class="form-control" name="contact_number"
                   value="{{ recipient.phone_number }}" pattern="[0-9]{11}" placeholder="01XXXXXXXXX" required>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Alternative Contact (Optional)</label>
        <input type="tel" class="form-control" name="alternative_contact" pattern="[0-9]{11}">
    </div>

    <!-- Notes -->
    <div class="mb-3">
        <label class="form-label">Additional Notes (Optional)</label>
        <textarea class="form-control" name="additional_notes" rows="3"></textarea>
    </div>

    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Important:</strong> The donor will receive an email with these details.
    </div>

    <!-- Actions -->
    <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Cancel
        </button>
        <button type="submit" class="btn btn-danger">
            <i class="bi bi-heart-pulse me-2"></i>Send Blood Request
        </button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const neededByInput = document.getElementById('needed_by_date');
    if (neededByInput) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        neededByInput.min = now.toISOString().slice(0, 16);
        const defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 2);
        defaultDate.setMinutes(defaultDate.getMinutes() - defaultDate.getTimezoneOffset());
        neededByInput.value = defaultDate.toISOString().slice(0, 16);
    }

    const form = document.getElementById('bloodRequestForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

            fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('requestModal'));
                    modal.hide();

                    // Show success alert
                    alert("✅ Blood request sent successfully!");
                } else {
                    document.getElementById('requestModalBody').innerHTML = data.html;
                }
            })
            .catch(() => alert('❌ Failed to send blood request. Try again.'))
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }

    // Phone validation
    document.querySelectorAll('input[type="tel"]').forEach(input => {
        input.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '').slice(0, 11);
        });
    });
});
</script>
