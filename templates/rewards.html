{% extends 'base.html' %}
{% load static %}

{% block title %}Rewards & Points - RoktoDan BD{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/rewards.css' %}">
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="rewards-hero" aria-labelledby="hero-title">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <div class="hero-content">
                    <h1 class="hero-title" id="hero-title">Your Donation Rewards</h1>
                    <p class="hero-description">
                        Every drop counts! Earn RD Points for each donation and unlock exclusive badges
                        as you save lives in your community.
                    </p>
                    {% if user.is_authenticated and donor %}
                        <div class="current-points">
                            <span class="points-label">Your RD Points</span>
                            <span class="points-value">{{ donor.points.available_points|default:0 }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-lg-6">
                <div class="hero-illustration">
                    <img src="{% static 'images/rewards-hero.png' %}" alt="Illustration of donation rewards" class="img-fluid">
                </div>
            </div>
        </div>
    </div>
</section>

{% if user.is_authenticated and donor %}
    <!-- User Dashboard Section -->
    <section class="user-dashboard" aria-labelledby="dashboard-title">
        <div class="container">
            <div class="row">
                <!-- Points Overview -->
                <div class="col-lg-4">
                    <div class="stat-card points-card">
                        <div class="stat-icon">
                            <i class="fas fa-coins" aria-hidden="true"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ donor.points.available_points|default:0 }}</h3>
                            <p>Available RD Points</p>
                            <small>Total Earned: {{ donor.points.total_points|default:0 }}</small>
                        </div>
                    </div>
                </div>

                <!-- Total Donations -->
                <div class="col-lg-4">
                    <div class="stat-card donations-card">
                        <div class="stat-icon">
                            <i class="fas fa-tint" aria-hidden="true"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ total_donations|default:0 }}</h3>
                            <p>Total Donations</p>
                            <small>Lives Saved: {{ lives_saved|default:0 }}</small>
                        </div>
                    </div>
                </div>

                <!-- Current Badge -->
                <div class="col-lg-4">
                    <div class="stat-card badge-card">
                        <div class="stat-icon">
                            <i class="fas fa-medal" aria-hidden="true"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ current_badge|default:"New Donor" }}</h3>
                            <p>Current Status</p>
                            <small>Next Goal: {% if next_milestone %}{{ next_milestone.count }} donations{% else %}Keep donating!{% endif %}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Earned Badges Section -->
    {% if earned_badges %}
    <section class="earned-badges" aria-labelledby="badges-title">
        <div class="container">
            <div class="section-header">
                <h2 id="badges-title">Your Achievement Badges</h2>
                <p>Celebrate your lifesaving milestones</p>
            </div>
            <div class="row">
                {% for badge in earned_badges %}
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="badge-item earned">
                        <div class="badge-icon">
                            <i class="fas {{ badge.badge_icon }}" aria-hidden="true"></i>
                        </div>
                        <h4>{{ badge.get_badge_type_display }}</h4>
                        <p>Earned on {{ badge.earned_date|date:"M d, Y" }}</p>
                        <span class="badge badge-{{ badge.badge_type }}">{{ badge.donation_count_when_earned }} donations</span>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center">
                    <p>No badges earned yet. Keep donating to unlock your first badge!</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Recent Transactions -->
    {% if recent_transactions %}
    <section class="recent-transactions" aria-labelledby="transactions-title">
        <div class="container">
            <div class="section-header">
                <h2 id="transactions-title">Recent Point Transactions</h2>
                <p>Track your reward history</p>
            </div>
            <div class="transactions-list">
                {% for transaction in recent_transactions %}
                <div class="transaction-item">
                    <div class="transaction-icon {% if transaction.transaction_type == 'earned' %}earned{% else %}spent{% endif %}">
                        <i class="fas {% if transaction.transaction_type == 'earned' %}fa-plus{% else %}fa-minus{% endif %}" aria-hidden="true"></i>
                    </div>
                    <div class="transaction-details">
                        <h5>{{ transaction.description }}</h5>
                        <p>{{ transaction.created_at|date:"M d, Y H:i" }}</p>
                    </div>
                    <div class="transaction-amount {% if transaction.transaction_type == 'earned' %}positive{% else %}negative{% endif %}">
                        {% if transaction.transaction_type == 'earned' %}+{% else %}-{% endif %}{{ transaction.point_amount }} RD Points
                    </div>
                </div>
                {% empty %}
                <div class="text-center">
                    <p>No recent transactions. Start donating to earn points!</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Withdrawal Section -->
    <section class="withdrawal-section" aria-labelledby="withdrawal-title">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="withdrawal-card">
                        <div class="card-header">
                            <h3 id="withdrawal-title"><i class="fas fa-money-bill-wave" aria-hidden="true"></i> Withdraw Points</h3>
                            <p>Convert your RD Points to cash via SSL Commerce</p>
                        </div>
                        <div class="card-body">
                            {% if donor.points.available_points >= 100 %}
                                <div class="withdrawal-info">
                                    <div class="conversion-rate">
                                        <span>Conversion Rate: <strong>1 RD Point = 1 BDT</strong></span>
                                    </div>
                                    <div class="min-withdrawal">
                                        <span>Minimum withdrawal: 100 RD Points</span>
                                    </div>
                                </div>

                                <form id="withdrawalForm" class="mt-4" aria-label="Withdrawal form">
                                    {% csrf_token %}
                                    <div class="form-group">
                                        <label for="pointsToWithdraw">Points to Withdraw</label>
                                        <input type="number" class="form-control" id="pointsToWithdraw"
                                               min="100" max="{{ donor.points.available_points }}"
                                               placeholder="Enter amount" aria-describedby="pointsHelp"
                                               required>
                                        <small id="pointsHelp" class="form-text text-muted">
                                            Available: {{ donor.points.available_points }} RD Points
                                        </small>
                                    </div>
                                    <div class="withdrawal-preview">
                                        <div class="preview-row">
                                            <span>Amount in BDT:</span>
                                            <span id="bdtAmount">0 BDT</span>
                                        </div>
                                        <div class="preview-row">
                                            <span>Processing Fee:</span>
                                            <span>Free</span>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-block withdrawal-btn" disabled
                                            aria-label="Submit withdrawal request">
                                        <i class="fas fa-credit-card" aria-hidden="true"></i>
                                        Withdraw via SSL Commerce (Coming Soon)
                                    </button>
                                </form>
                            {% else %}
                                <div class="insufficient-points">
                                    <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                                    <h4>Insufficient Points</h4>
                                    <p>You need at least 100 RD Points to make a withdrawal.</p>
                                    <p>Current balance: {{ donor.points.available_points|default:0 }} RD Points</p>
                                    <p>Donate blood to earn more points!</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endif %}

<!-- Badge System Overview -->
<section class="badge-system" aria-labelledby="badge-system-title">
    <div class="container">
        <div class="section-header">
            <h2 id="badge-system-title">Achievement Badge System</h2>
            <p>Unlock exclusive badges as you continue your donation journey</p>
        </div>
        <div class="row">
            {% for badge in all_badges %}
            <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                <div class="badge-item {% if badge.badge_type in earned_badge_types %}earned{% endif %}">
                    <div class="badge-icon">
                        <i class="fas {{ badge.icon }}" aria-hidden="true"></i>
                    </div>
                    <h4>{{ badge.name }}</h4>
                    <p>{{ badge.description }}</p>
                    <span class="badge badge-{{ badge.badge_type }}">{{ badge.count }} donations</span>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center">
                <p>No badges available. Check back later!</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

{% if not user.is_authenticated %}
<!-- Call to Action -->
<section class="cta-section" aria-labelledby="cta-title">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <div class="cta-content">
                    <h2 id="cta-title">Start Earning Rewards Today</h2>
                    <p>Join RoktoDan BD and start earning RD Points for every life you save</p>
                    <div class="cta-buttons">
                        <a href="{% url 'register_donor' %}" class="btn btn-primary btn-lg" aria-label="Register as a donor">
                            <i class="fas fa-user-plus" aria-hidden="true"></i>
                            Register as Donor
                        </a>
                        <a href="{% url 'login' %}" class="btn btn-outline-primary btn-lg" aria-label="Login to your account">
                            <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                            Login
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pointsInput = document.getElementById('pointsToWithdraw');
    const bdtAmount = document.getElementById('bdtAmount');
    const withdrawButton = document.querySelector('.withdrawal-btn');

    if (pointsInput && withdrawButton) {
        pointsInput.addEventListener('input', function() {
            const points = parseInt(this.value) || 0;
            const maxPoints = parseInt(this.max) || 0;
            const bdt = points * 1; // 1 RD Point = 1 BDT
            bdtAmount.textContent = bdt + ' BDT';
            withdrawButton.disabled = points < 100 || points > maxPoints;
        });
    }

    // Animate numbers in stat cards
    function animateNumber(element) {
        const finalNumber = parseInt(element.textContent) || 0;
        let currentNumber = 0;
        const increment = Math.ceil(finalNumber / 30);

        const timer = setInterval(() => {
            currentNumber += increment;
            if (currentNumber >= finalNumber) {
                element.textContent = finalNumber;
                clearInterval(timer);
            } else {
                element.textContent = currentNumber;
            }
        }, 50);
    }

    document.querySelectorAll('.stat-card h3').forEach(statValue => {
        animateNumber(statValue);
    });
});
</script>
{% endblock %}